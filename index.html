<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>P2P Voice Call (Timer Fixed)</title>
  <style>
    body { background: #111; color: #fff; font-family: sans-serif; text-align: center; padding: 20px; }
    input, button { margin: 6px; padding: 10px; font-size: 16px; border-radius: 8px; border: none; }
    button { background: #222; color: #0f0; }
    #callInfo, #timer { margin-top: 10px; font-weight: bold; }
    #timer { font-size: 20px; color: lightgreen; }
  </style>
</head>
<body>
  <h2>🔊 P2P Voice Call</h2>
  <input id="myCustomId" placeholder="Your Custom ID"><br>
  <button onclick="registerPeer()">🔗 Register</button><br>
  <input id="otherId" placeholder="Call to ID"><br>
  <button onclick="startCall()">📞 Call</button>
  <button onclick="endCall()">❌ End</button>
  <button onclick="toggleMic()">🎙️ Mic</button>
  <div id="callInfo">No call yet</div>
  <div id="timer">00:00</div>
  <audio id="remoteAudio" autoplay></audio>

  <script src="https://cdn.jsdelivr.net/npm/peerjs@1.3.2/dist/peerjs.min.js"></script>
  <script>
    let peer, currentCall = null, incomingCall = null, localStream = null, timerInterval, callStartTime;

    function registerPeer() {
      const id = document.getElementById("myCustomId").value.trim();
      if (!id) return alert("Enter your ID");
      peer = new Peer(id, { host: '0.peerjs.com', secure: true, port: 443 });

      peer.on("open", pid => {
        document.getElementById("callInfo").innerText = "✅ Registered as: " + pid;
        if (window.Android) Android.onMyId(pid);
      });

      peer.on("error", err => {
        alert("⚠️ PeerJS error: " + err);
        if (window.Android) Android.onError(err.toString());
      });

      peer.on("call", incoming => {
        incomingCall = incoming;
        document.getElementById("callInfo").innerText = "📥 Incoming: " + incoming.peer;
        if (window.Android) Android.onIncomingCall(incoming.peer);
      });
    }

    function answerCall() {
      if (!incomingCall) return;
      navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
        localStream = stream;
        incomingCall.answer(stream);
        currentCall = incomingCall;
        incomingCall.on("stream", remoteStream => {
          playStream(remoteStream);
          showCallInfo(incomingCall.peer); // ✅ Timer starts here
        });
        incomingCall = null;
      });
    }

    function startCall() {
      const id = document.getElementById("otherId").value.trim();
      if (!id) return alert("Enter ID to call");
      navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
        localStream = stream;
        currentCall = peer.call(id, stream);
        currentCall.on("stream", remoteStream => {
          playStream(remoteStream);
          showCallInfo(id); // ✅ Timer starts here
        });
      });
    }

    function endCall() {
      if (currentCall) currentCall.close();
      currentCall = null;
      stopTimer();
      document.getElementById("callInfo").innerText = "❌ Call Ended";
      if (window.Android && Android.onCallEnded) Android.onCallEnded();
    }

    function toggleMic() {
      if (localStream) {
        const mic = localStream.getAudioTracks()[0];
        mic.enabled = !mic.enabled;
        if (window.Android) Android.onMicToggled(mic.enabled);
      }
    }

    function playStream(stream) {
      const audio = document.getElementById("remoteAudio");
      audio.srcObject = stream;
      audio.play();
    }

    function showCallInfo(peerId) {
      document.getElementById("callInfo").innerText = "✅ Connected to: " + peerId;
      startTimer(); // ✅ Timer starts now
      if (window.Android) Android.onCallConnected(peerId);
    }

    function startTimer() {
      callStartTime = Date.now();
      timerInterval = setInterval(() => {
        const sec = Math.floor((Date.now() - callStartTime) / 1000);
        const m = String(Math.floor(sec / 60)).padStart(2, "0");
        const s = String(sec % 60).padStart(2, "0");
        const time = `${m}:${s}`;
        document.getElementById("timer").innerText = time;
        if (window.Android) Android.onCallDuration(time);
      }, 1000);
    }

    function stopTimer() {
      clearInterval(timerInterval);
      document.getElementById("timer").innerText = "00:00";
    }
  </script>
</body>
</html>
