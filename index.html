<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>P2P Call - Caller Side Timeout</title>
  <style>
    body { background: #111; color: #fff; font-family: sans-serif; text-align: center; padding: 20px; }
    input, button { margin: 6px; padding: 10px; font-size: 16px; border-radius: 8px; border: none; }
    button { background: #222; color: #0f0; }
    #callInfo, #timer { margin-top: 10px; font-weight: bold; }
    #timer { font-size: 20px; color: lightgreen; }
  </style>
</head>
<body>
  <h2>üìû P2P Voice Call</h2>
  <input id="myCustomId" placeholder="Your Custom ID"><br>
  <button onclick="registerPeer()">üîó Register</button><br>
  <input id="otherId" placeholder="Call to ID"><br>
  <button onclick="startCall()">üìû Call</button>
  <button onclick="answerCall()">‚úÖ Answer</button>
  <button onclick="endCall()">‚ùå End</button>
  <div id="callInfo">No call yet</div>
  <div id="timer">00:00</div>
  <audio id="remoteAudio" autoplay></audio>

  <script src="https://cdn.jsdelivr.net/npm/peerjs@1.3.2/dist/peerjs.min.js"></script>
  <script>
    let peer, currentCall = null, incomingCall = null, localStream = null;
    let timerInterval, callStartTime;

    function registerPeer() {
      const id = document.getElementById("myCustomId").value.trim();
      if (!id) return alert("Enter your ID");
      peer = new Peer(id, { host: '0.peerjs.com', secure: true, port: 443 });

      peer.on("open", pid => {
        document.getElementById("callInfo").innerText = "‚úÖ Registered as: " + pid;
        if (window.Android) Android.onMyId(pid);
      });

      peer.on("error", err => {
        alert("‚ö†Ô∏è PeerJS error: " + err);
        if (window.Android) Android.onError(err.toString());
      });

      peer.on("call", incoming => {
        incomingCall = incoming;
        document.getElementById("callInfo").innerText = "üì• Incoming: " + incoming.peer;
        if (window.Android) Android.onIncomingCall(incoming.peer);

        // No auto message shown on receiver here. Receiver handles timeout in app.
      });
    }

    function answerCall() {
      if (!incomingCall) return;
      navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
        localStream = stream;
        incomingCall.answer(stream);
        currentCall = incomingCall;
        incomingCall.on("stream", remoteStream => {
          playStream(remoteStream);
          showCallInfo(incomingCall.peer);
        });
        incomingCall = null;
      });
    }

    function startCall() {
      const id = document.getElementById("otherId").value.trim();
      if (!id) return alert("Enter ID to call");

      navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
        localStream = stream;
        currentCall = peer.call(id, stream);

        let answered = false;

        currentCall.on("stream", remoteStream => {
          answered = true;
          playStream(remoteStream);
          showCallInfo(id);
        });

        // ‚úÖ Only the caller sees timeout message if unanswered
        setTimeout(() => {
          if (!answered) {
            document.getElementById("callInfo").innerText = "‚ùå " + id + " did not receive the call";
            if (window.Android) Android.onMissedCall(id);
            currentCall.close();
          }
        }, 30000);
      });
    }

    function endCall() {
      if (currentCall) currentCall.close();
      currentCall = null;
      stopTimer();
      document.getElementById("callInfo").innerText = "‚ùå Call Ended";
      if (window.Android && Android.onCallEnded) Android.onCallEnded();
    }

    function playStream(stream) {
      const audio = document.getElementById("remoteAudio");
      audio.srcObject = stream;
      audio.play();
    }

    function showCallInfo(peerId) {
      document.getElementById("callInfo").innerText = "‚úÖ Connected to: " + peerId;
      startTimer();
      if (window.Android) Android.onCallConnected(peerId);
    }

    function startTimer() {
      callStartTime = Date.now();
      timerInterval = setInterval(() => {
        const sec = Math.floor((Date.now() - callStartTime) / 1000);
        const m = String(Math.floor(sec / 60)).padStart(2, "0");
        const s = String(sec % 60).padStart(2, "0");
        const time = `${m}:${s}`;
        document.getElementById("timer").innerText = time;
        if (window.Android) Android.onCallDuration(time);
      }, 1000);
    }

    function stopTimer() {
      clearInterval(timerInterval);
      document.getElementById("timer").innerText = "00:00";
    }
  </script>
</body>
</html>
